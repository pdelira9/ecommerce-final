<div class="max-w-6xl mx-auto py-8 px-4">
  <h1 class="text-3xl font-bold mb-6 text-center">Checkout</h1>

  @if (cartSig(); as cart) {
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <div class="lg:col-span-2 space-y-6">

        <div class="bg-white shadow rounded-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Dirección de envío</h2>
            <a routerLink="/user/shipping-address" class="text-sm text-blue-600 hover:underline">
              Administrar
            </a>
          </div>

          @if (shippingAddresses$ | async; as addresses) {
            @if (addresses.length === 0) {
              <p class="text-gray-600 text-sm mb-2">No tienes direcciones registradas.</p>
              <a routerLink="/user/shipping-address" class="text-sm text-blue-600 hover:underline">
                Agregar una dirección
              </a>
            } @else {
              <div class="space-y-3">
                @for (address of addresses; track address._id) {
                  <label class="flex items-start gap-3 cursor-pointer border rounded-lg p-3 hover:bg-gray-50">
                    <input
                      type="radio"
                      name="shippingAddress"
                      [checked]="selectedShippingAddressId === address._id"
                      (change)="onAddressSelected(address._id)"
                      class="mt-1"
                    />
                    <div class="text-sm">
                      <p class="font-semibold">{{ address.name }}</p>
                      <p class="text-gray-700">{{ address.address }}</p>
                      <p class="text-gray-600">
                        {{ address.city }}, {{ address.state }} {{ address.postalCode }} — {{ address.country }}
                      </p>
                      <p class="text-gray-600">Tel: {{ address.phone }}</p>

                      @if (address.isDefault) {
                        <span class="inline-block mt-2 text-xs px-2 py-1 rounded bg-green-100 text-green-700">
                          Predeterminada
                        </span>
                      }
                    </div>
                  </label>
                }
              </div>
            }
          }
        </div>

        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">Método de pago</h2>
          @if (paymentMethods$ | async; as payments) {
            <app-payment-methods-list
              [paymentMethods]="payments"
              [isSelectable]="true"
              [selectedId]="paymentMethodId || null"
              (select)="onPaymentSelected($event)">
            </app-payment-methods-list>

            @if (payments.length === 0) {
              <p class="text-gray-600 text-sm mt-3">No tienes métodos de pago. Agrega uno en “Mi Cuenta”.</p>
              <a routerLink="/user/paymethods" class="text-sm text-blue-600 hover:underline">
                Agregar método de pago
              </a>
            }
          }
        </div>

      </div>

      <div class="space-y-6">
        <div class="bg-white shadow rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">Resumen</h2>

          <div class="divide-y">
            @for (item of cart.products; track item) {
              <div class="py-2 flex items-center justify-between text-sm">
                <div class="flex-1 pr-2">
                  <p class="font-medium line-clamp-1">{{ item.product.name }}</p>
                  <p class="text-gray-500">x{{ item.quantity }}</p>
                </div>
                <div class="font-semibold">{{ item.product.price * item.quantity | currency }}</div>
              </div>
            }
          </div>

          <div class="border-t mt-4 pt-4 flex justify-between font-bold text-lg">
            <span>Total</span>
            <span>{{ total() | currency }}</span>
          </div>

          <button
            (click)="submitOrder()"
            [disabled]="loading()"
            class="w-full mt-4 bg-green-600 text-white py-3 rounded hover:bg-green-700 disabled:opacity-50">
            {{ loading() ? 'Procesando...' : 'Confirmar Pedido' }}
          </button>

          @if (errorMsg()) {
            <p class="text-red-600 text-sm mt-2">{{ errorMsg() }}</p>
          }
        </div>
      </div>

    </div>
  } @else {
    <div class="text-center py-20">
      <p class="text-gray-600 mb-4">No hay productos en el carrito.</p>
      <a routerLink="/user/cart" class="inline-block bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
        Volver al carrito
      </a>
    </div>
  }
</div>
